---
title: How On-Demand Services Process Commands
owner: London Services Enablement
---

The sequence diagrams in this topic show how an on-demand service sets up and 
maintains service instances. 
The diagrams indicate which tasks are undertaken by the on-demand broker (ODB) and 
which require interaction with the Service Adapter.

## <a id="catalog"></a>Register Service Broker with Cloud Foundry

<%= partial 'mmd/service_catalog_workflow.mmd' %>

## <a id="create-service-instance"></a>Create Service Instance

There are two ways this process can fail: 

- **Synchronously:** The Cloud Controller deletes the service according 
to its orphan mitigation strategy.
For more information, see [Orphans](http://docs.cloudfoundry.org/services/api.html#orphans). 

-  **Asynchronously:** This happens while BOSH deploys the service instance. 
The Cloud Controller does not issue a delete request.

<%= partial 'mmd/create_service_workflow.mmd' %>

## <a id="delete-service-instance"></a>Delete Service Instance

In the delete service workflow the service adapter is not invoked.

<%= partial 'mmd/delete_service_workflow.mmd' %>

## <a id="post-deploy"></a>Create/Update Service Instance with Post-Deploy Errands

ODB does not report create/update success to Cloud Foundry until the deployment 
and all the post-deploy errands complete successfully.

<%= partial 'mmd/create_post_deploy_workflow.mmd' %>

## <a id="pre-delete"></a>Delete Service Instance with Pre-Delete Errand

ODB does not report delete success to Cloud Foundry until all the pre-delete 
errands and delete deployment complete successfully.

<%= partial 'mmd/pre_delete_workflow.mmd' %>

## <a id="update-service-instance"></a>Update Service Instance

Updates can only proceed if the existing service instance is up-to-date. ODB calls `generate-manifest` on service adapter to determine whether there are any pending changes for the instance.

### <a id="update-service-instance-with-changes"></a>Update When There Are Pending Changes

<p class="note"><strong>Note</strong>: When determining whether there are pending changes for an instance during an update, ODB <em>ignores</em> any configuration supplied in the <a href="https://bosh.io/docs/deployment-manifest.html#update" target="_blank">update block of the manifest</a> returned by the service adapter's <code>generate-manifest</code> subcommand.</p>

<%= partial 'mmd/update_service_with_pending_changes_workflow.mmd' %>

### <a id="update-service-instance-no-changes"></a>Update When There Are No Pending Changes

The manifest from the second call to `generate-manifest` is deployed.

<%= partial 'mmd/update_service_no_pending_changes_workflow.mmd' %>

## <a id="bind"></a>Bind

<%= partial 'mmd/bind_service_workflow.mmd' %>

## <a id="unbind"></a>Unbind

<%= partial 'mmd/unbind_service_workflow.mmd' %>

## <a id="upgrade-all-instances"></a>Upgrade All Service Instances

ODB provides a BOSH errand to upgrade all the instances managed by the broker. 
This is also used when a plan changes.
The errand updates all instances that implement a plan with the new plan definition.

<%= partial 'mmd/upgrade_all_instances_workflow.mmd' %>

## <a id="upgrade-all-instances"></a>Upgrade All Service Instances with External Service Instances API Configured

If the service instances API is configured, the `upgrade-all-service-instances` 
errand connects to a different endpoint to gather the list of instances to upgrade. 
For more information, see [Service Instances API](upgrades.html#service-instances-api).

<%= partial 'mmd/upgrade_all_instances_with_si_api_workflow.mmd' %>

## <a id="delete-all-instances"></a>Delete All Service Instances

ODB provides a BOSH errand to delete all the instances managed by the broker.

<%= partial 'mmd/delete_all_instances_workflow.mmd' %>

## <a id="delete-all-instances"></a>Delete All Service Instances and Deregister Broker

ODB provides a BOSH errand to delete all the instances managed by the broker and 
to deregister the broker from Cloud Foundry.

<%= partial 'mmd/delete_all_instances_and_deregister_broker_workflow.mmd' %>
